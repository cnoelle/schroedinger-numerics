<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase space demo</title>
</head>
<body>
    <h1>Phase space demo</h1>
    <div id="phase-space-flex" style="display: grid; grid-template-columns: auto auto 1fr; 
            column-gap: 1em; row-gap: 1em; justify-items: center;">
        <div id="title1" style="font-size: 1.5em;"></div><div id="title2" style="font-size: 1.5em;"></div><div></div>
        <div>
            <phase-space width="530" height="530" boundary="50" grid="true"></phase-space>
        </div>
        <div id="ph2"></div>
        <div></div>
    </div>
    <div style="display: flex; column-gap: 1em;">
        <input type="button" id="run" value="Run" style="cursor: pointer;" title="Start the animation">
        <input type="button" id="stop" value="Stop" disabled="disabled" style="cursor: pointer;" 
            title="Stop the animation">
        <input type="file" id="file" accept="application/json,text/csv" multiple="multiple">
        <input type="button" id="upload" value="Upload" style="cursor: pointer;" title="Start file upload" disabled="disabled">
    </div>
    <script type="module">
        import { PhaseSpaceWidget, Density } from "./bundle.js";
        import { FileImport } from "./fileImport.js";
        PhaseSpaceWidget.register();

        const phaseSpace = document.querySelector("phase-space");

        const width = phaseSpace.width - phaseSpace.boundary;
        const height = phaseSpace.height - phaseSpace.boundary;
        const values = new Uint8ClampedArray(width * height);
        const density = new Density(values, width, {maxValue: 255, xRange: [0, 10], pRange: [0, 10]});
        phaseSpace.values = density;

        const runBtn = document.querySelector("input#run");
        const stopBtn = document.querySelector("input#stop");

        let stopped = false;
        
        function runAnimation() {
            stopped = false;
            runBtn.setAttribute("disabled", "disabled");
            stopBtn.removeAttribute("disabled");
            let start = undefined;
            
            const center = t => {
                const delta = 2 * Math.PI * t;
                return [(2 + Math.sin(delta)) * width / 4,  (2 + Math.cos(delta)) * height / 4];
            }
            /**
             * Here x and y are indices. x runs from 0 to 479 and y from 0 to 239.
             * center is of type [number, number]
             */
            const lengthScaleX = width / 20;
            const lengthScaleY = height / 20;
            const distanceSqrFromCenter = (x, y, center) => {
                const delX = (x - center[0]) / lengthScaleX;
                const delY = (y - center[1]) / lengthScaleY;
                return delX * delX + delY * delY;
            }

            function step(t) {
                if (start === undefined)
                    start = t;
                const secondsElapsed = (t - start)/1000;
                const cent = center(secondsElapsed);
                const arr = [0];
                for (let y=0; y<height; y++) {
                    const rowStart = y * width;
                    for (let x=0; x<width; x++) {
                        const d = Math.max(1, distanceSqrFromCenter(x, y, cent)); 
                        arr[0] = 255/d; // TODO proper value
                        values.set(arr, rowStart + x);
                    }    
                }
                phaseSpace.draw();
                if (!stopped)
                    window.requestAnimationFrame(step);
            }

            window.requestAnimationFrame(step);
        }
        function stopAnimation() {
            stopped = true;
            stopBtn.setAttribute("disabled", "disabled");
            runBtn.removeAttribute("disabled");
        }
        let currentRunListener = runAnimation;
        let currentStopListener = stopAnimation;
        let currentCloseListener = stopAnimation;

        runBtn.addEventListener("click", currentRunListener);
        stopBtn.addEventListener("click", currentStopListener);
        runAnimation();
        stopAnimation();
        
        // allows running those functions from the developer console
        window.phaseSpace = {
            runAnimation: runAnimation,
            stopAnimation: stopAnimation
        };

        const fileBtn = document.querySelector("input#file");
        const uploadBtn = document.querySelector("input#upload");

        fileBtn.addEventListener("change", e => {
            const empty = !e.currentTarget.value;
            if (empty)
                uploadBtn.setAttribute("disabled", "disabled");
            else
                uploadBtn.removeAttribute("disabled");
        });
        fileBtn.dispatchEvent(new Event("change"));

        async function uploadFile() {
            const files = fileBtn.files;
            if (!(files?.length > 0))
                return;
            const isMulti = files.length > 1;
            let result;
            try {
                result = isMulti ? await FileImport.readWaveFunction(Array.from(files)) : await FileImport.readPhaseSpace(files[0]);
                if (!result)
                    throw new Error("empty");
            } catch(e) {
                console.log("Failed to upload file", e);
                return;
            }
            currentCloseListener();
            runBtn.removeEventListener("click", currentRunListener);
            stopBtn.removeEventListener("click", currentStopListener);
            let animationController;
            if (Array.isArray(result)) {
                const ph2 = document.createElement("phase-space");
                ph2.width = 530;
                ph2.height = 530;
                ph2.boundary = 50;
                ph2.grid = true;
                document.querySelector("#ph2").appendChild(ph2);
                const closeListener = () => { 
                    ph2.remove();
                    document.querySelector("div#title2").innerText = "";
                }
                animationController = FileImport.setupAnimationWfs(result, [phaseSpace, ph2], closeListener);
                document.querySelector("div#title1").innerText = result[0].title;
                document.querySelector("div#title2").innerText = result[1].title;
            } else {
                animationController = isMulti ? FileImport.setupAnimationWf(result, phaseSpace) : 
                    FileImport.setupAnimation(result, phaseSpace);
                if (isMulti)
                    document.querySelector("div#title1").innerText = result.title;
            }
            animationController.addListener({
                started: () => {
                    runBtn.setAttribute("disabled", "disabled");
                    stopBtn.removeAttribute("disabled");
                },
                stopped: () => {
                    stopBtn.setAttribute("disabled", "disabled");
                    runBtn.removeAttribute("disabled");
                }
            });
            currentRunListener = () => animationController.run();
            currentStopListener = () => animationController.stop();
            currentCloseListener = () => animationController.close();
            runBtn.addEventListener("click", currentRunListener);
            stopBtn.addEventListener("click", currentStopListener);
            window.phaseSpace = {
                runAnimation: currentRunListener,
                stopAnimation: currentStopListener
            };
            animationController.init();
        }
        uploadBtn.addEventListener("click", uploadFile);


    </script>
</body>
